% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/mmm_clustering_cov.R
\name{cluster_m}
\alias{cluster_m}
\title{Mixture Markov Model Clustering with Covariates for Sequences}
\usage{
cluster_m(
  sequence,
  data,
  k,
  covariate_effects = c("transitions"),
  random_effects = FALSE,
  max_iter = 500L,
  tol = 1e-06,
  n_starts = 5L,
  seed = NULL,
  verbose = TRUE,
  min_cluster_size = 1L,
  smoothing = 0.01,
  regularization = 0.01,
  allow_approximate = TRUE,
  min_successful_starts = 1L
)
}
\arguments{
\item{sequence}{A data frame or matrix where rows represent sequences and columns
represent time points. Missing values (NA) are handled appropriately.
Each cell should contain a state label (character or factor).}

\item{data}{A data frame with covariates/predictors. Must have the same number of
rows as \code{sequence}. Can include both continuous and categorical variables.
This will be automatically converted to a model matrix with dummy variables
for factors.}

\item{k}{An integer specifying the number of mixture components (clusters).
Must be between 2 and the number of sequences minus 1.}

\item{covariate_effects}{A character vector specifying which model components
should include covariate effects. Options include:
\itemize{
\item "transitions" - covariates affect transition probabilities (default)
\item "initial" - covariates affect initial state probabilities
\item "mixture" - covariates affect mixture weights
}
Multiple effects can be specified.}

\item{random_effects}{A logical indicating whether to include individual-level
random effects to capture unobserved heterogeneity. When TRUE, adds
individual-specific random intercepts to account for sequence-level variation
not explained by the observed covariates. This helps model individual
differences in baseline propensities. Default is FALSE.}

\item{max_iter}{An integer specifying the maximum number of EM iterations
per restart. Default is 500 (increased due to complexity).}

\item{tol}{A numeric value specifying the convergence tolerance for the
log-likelihood change between iterations. Default is 1e-6.}

\item{n_starts}{An integer specifying the number of random restarts to
perform. Default is 5 (reduced due to increased computational cost).}

\item{seed}{An integer for random seed setting to ensure reproducibility.
If NULL, uses current random state. Default is NULL.}

\item{verbose}{A logical value indicating whether to print progress
information during fitting. Default is TRUE.}

\item{min_cluster_size}{An integer specifying the minimum number of sequences
required per cluster for a solution to be considered valid. Default is 1.}

\item{smoothing}{A numeric value for Laplace smoothing parameter to prevent
zero probabilities. Default is 0.01 (reduced for covariate models).}

\item{regularization}{A numeric value for L2 regularization of covariate
coefficients to prevent overfitting. Default is 0.01.}

\item{allow_approximate}{A logical value indicating whether to return
approximate solutions when perfect convergence is not achieved. When TRUE,
provides best available solution with quality warnings. Default is TRUE.}

\item{min_successful_starts}{An integer specifying the minimum number of
successful EM runs required when allow_approximate=FALSE. Default is 1.}
}
\value{
A list of class \code{mmm_cov_result} containing:
\describe{
\item{assignments}{Integer vector of cluster assignments for each sequence}
\item{responsibilities}{Matrix of posterior probabilities (n_sequences x k)}
\item{log_likelihood}{Final log-likelihood of the best model}
\item{bic}{Bayesian Information Criterion}
\item{aic}{Akaike Information Criterion}
\item{models}{List of k trained Markov models with covariate effects}
\item{mixture_weights}{Named vector of cluster mixing weights (or covariate model)}
\item{covariate_effects}{List of covariate coefficient matrices for each component}
\item{random_effects}{Individual random effects (if included)}
\item{k}{Number of clusters}
\item{n_parameters}{Total number of model parameters}
\item{converged}{Logical indicating convergence of best model}
\item{n_iterations}{Number of iterations for best model}
\item{cluster_sizes}{Named vector of cluster sizes}
\item{cluster_proportions}{Named vector of cluster proportions}
\item{covariate_summary}{Summary of covariate effects}
\item{states}{Character vector of unique states in data}
\item{covariates_used}{Names of covariates used in the model}
\item{call}{The matched call}
}
}
\description{
Fits a mixture of first-order Markov models with covariate effects to sequence
data using the Expectation-Maximization (EM) algorithm. Allows covariates to
influence transition probabilities and optionally initial state probabilities
and mixture weights.
}
\details{
This function extends the mixture Markov model to include covariate effects.
Covariates can influence:
\itemize{
\item Transition probabilities via multinomial logistic regression
\item Initial state probabilities via multinomial logistic regression
\item Mixture weights via multinomial logistic regression
}

The model uses logistic regression to relate covariates to probabilities:
\deqn{logit(P(s_t = j | s_{t-1} = i, X)) = \alpha_{ij} + \beta_{ij}^T X}

Random effects can be included to account for individual heterogeneity
beyond what is captured by observed covariates.
}
\examples{
\dontrun{
# Create example sequence data
sequence <- data.frame(
  T1 = c("A", "B", "A", "C", "A", "B"),
  T2 = c("B", "A", "B", "A", "C", "A"),
  T3 = c("C", "C", "A", "B", "B", "C")
)

# Create covariate data
data <- data.frame(
  age = c(25, 45, 35, 55, 30, 40),
  gender = factor(c("M", "F", "M", "F", "M", "F")),
  score = c(2.1, 3.5, 1.8, 4.2, 2.7, 3.1)
)

# Fit MMM with covariates affecting transitions
result <- cluster_m(sequence, data, k = 2, 
                   covariate_effects = "transitions")
print(result)

# Fit with random effects to capture individual heterogeneity
result_re <- cluster_m(sequence, data, k = 2,
                      covariate_effects = "transitions",
                      random_effects = TRUE)
print(result_re)
}

}
